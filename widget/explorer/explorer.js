//var data1 = [{"title":"Databases","iconUrl":"../images/db-icon.jpg","childNodes":[{"title":"admin","iconUrl":"../images/database-icon.jpg","childNodes":[{"title":"Collections","iconUrl":"../images/folder-icon.jpg","childNodes":[{"title":"hello","iconUrl":"../images/collection-icon.png","contextMenu":[{"title":"Add Record"},{"title":"Drop Collection"}]},{"title":"asdsad","iconUrl":"../images/collection-icon.png","contextMenu":[{"title":"Add Record"},{"title":"Drop Collection"}]}],"contextMenu":[{"title":"Add Collection"}]}],"contextMenu":[{"title":"Drop Database"}]},{"title":"local","iconUrl":"../images/database-icon.jpg","childNodes":[{"title":"Collections","iconUrl":"../images/folder-icon.jpg","childNodes":[{"title":"startup_log","iconUrl":"../images/collection-icon.png","contextMenu":[{"title":"Add Record"},{"title":"Drop Collection"}]},{"title":"hello","iconUrl":"../images/collection-icon.png","contextMenu":[{"title":"Add Record"},{"title":"Drop Collection"}]},{"title":"asdaddasd","iconUrl":"../images/collection-icon.png","contextMenu":[{"title":"Add Record"},{"title":"Drop Collection"}]}],"contextMenu":[{"title":"Add Collection"}]}],"contextMenu":[{"title":"Drop Database"}]},{"title":"te25","iconUrl":"../images/database-icon.jpg","childNodes":[{"title":"Collections","iconUrl":"../images/folder-icon.jpg","childNodes":[],"contextMenu":[{"title":"Add Collection"}]}],"contextMenu":[{"title":"Drop Database"}]},{"title":"test","iconUrl":"../images/database-icon.jpg","childNodes":[{"title":"Collections","iconUrl":"../images/folder-icon.jpg","childNodes":[{"title":"Collection 1","iconUrl":"../images/collection-icon.png","contextMenu":[{"title":"Add Record"},{"title":"Drop Collection"}]},{"title":"test6777","iconUrl":"../images/collection-icon.png","contextMenu":[{"title":"Add Record"},{"title":"Drop Collection"}]},{"title":"coll2","iconUrl":"../images/collection-icon.png","contextMenu":[{"title":"Add Record"},{"title":"Drop Collection"}]},{"title":"dadsadsads","iconUrl":"../images/collection-icon.png","contextMenu":[{"title":"Add Record"},{"title":"Drop Collection"}]},{"title":"colll3","iconUrl":"../images/collection-icon.png","contextMenu":[{"title":"Add Record"},{"title":"Drop Collection"}]},{"title":"colll5","iconUrl":"../images/collection-icon.png","contextMenu":[{"title":"Add Record"},{"title":"Drop Collection"}]},{"title":"collll23","iconUrl":"../images/collection-icon.png","contextMenu":[{"title":"Add Record"},{"title":"Drop Collection"}]},{"title":"asddd","iconUrl":"../images/collection-icon.png","contextMenu":[{"title":"Add Record"},{"title":"Drop Collection"}]},{"title":"adasadad","iconUrl":"../images/collection-icon.png","contextMenu":[{"title":"Add Record"},{"title":"Drop Collection"}]}],"contextMenu":[{"title":"Add Collection"}]}],"contextMenu":[{"title":"Drop Database"}]},{"title":"test2","iconUrl":"../images/database-icon.jpg","childNodes":[{"title":"Collections","iconUrl":"../images/folder-icon.jpg","childNodes":[{"title":"coll1","iconUrl":"../images/collection-icon.png","contextMenu":[{"title":"Add Record"},{"title":"Drop Collection"}]}],"contextMenu":[{"title":"Add Collection"}]}],"contextMenu":[{"title":"Drop Database"}]},{"title":"test22","iconUrl":"../images/database-icon.jpg","childNodes":[{"title":"Collections","iconUrl":"../images/folder-icon.jpg","childNodes":[{"title":"coll1","iconUrl":"../images/collection-icon.png","contextMenu":[{"title":"Add Record"},{"title":"Drop Collection"}]},{"title":"c","iconUrl":"../images/collection-icon.png","contextMenu":[{"title":"Add Record"},{"title":"Drop Collection"}]}],"contextMenu":[{"title":"Add Collection"}]}],"contextMenu":[{"title":"Drop Database"}]},{"title":"test23","iconUrl":"../images/database-icon.jpg","childNodes":[{"title":"Collections","iconUrl":"../images/folder-icon.jpg","childNodes":[],"contextMenu":[{"title":"Add Collection"}]}],"contextMenu":[{"title":"Drop Database"}]},{"title":"test24","iconUrl":"../images/database-icon.jpg","childNodes":[{"title":"Collections","iconUrl":"../images/folder-icon.jpg","childNodes":[],"contextMenu":[{"title":"Add Collection"}]}],"contextMenu":[{"title":"Drop Database"}]},{"title":"test26","iconUrl":"../images/database-icon.jpg","childNodes":[{"title":"Collections","iconUrl":"../images/folder-icon.jpg","childNodes":[],"contextMenu":[{"title":"Add Collection"}]}],"contextMenu":[{"title":"Drop Database"}]},{"title":"test27","iconUrl":"../images/database-icon.jpg","childNodes":[{"title":"Collections","iconUrl":"../images/folder-icon.jpg","childNodes":[],"contextMenu":[{"title":"Add Collection"}]}],"contextMenu":[{"title":"Drop Database"}]},{"title":"test28","iconUrl":"../images/database-icon.jpg","childNodes":[{"title":"Collections","iconUrl":"../images/folder-icon.jpg","childNodes":[],"contextMenu":[{"title":"Add Collection"}]}],"contextMenu":[{"title":"Drop Database"}]},{"title":"test29","iconUrl":"../images/database-icon.jpg","childNodes":[{"title":"Collections","iconUrl":"../images/folder-icon.jpg","childNodes":[],"contextMenu":[{"title":"Add Collection"}]}],"contextMenu":[{"title":"Drop Database"}]}],"contextMenu":[{"title":"Add Database"}]}][{"title":"Databases","iconUrl":"../images/db-icon.jpg","childNodes":[{"title":"admin","iconUrl":"../images/database-icon.jpg","childNodes":[{"title":"Collections","iconUrl":"../images/folder-icon.jpg","childNodes":[{"title":"hello","iconUrl":"../images/collection-icon.png","contextMenu":[{"title":"Add Record"},{"title":"Drop Collection"}]},{"title":"asdsad","iconUrl":"../images/collection-icon.png","contextMenu":[{"title":"Add Record"},{"title":"Drop Collection"}]}],"contextMenu":[{"title":"Add Collection"}]}],"contextMenu":[{"title":"Drop Database"}]},{"title":"local","iconUrl":"../images/database-icon.jpg","childNodes":[{"title":"Collections","iconUrl":"../images/folder-icon.jpg","childNodes":[{"title":"startup_log","iconUrl":"../images/collection-icon.png","contextMenu":[{"title":"Add Record"},{"title":"Drop Collection"}]},{"title":"hello","iconUrl":"../images/collection-icon.png","contextMenu":[{"title":"Add Record"},{"title":"Drop Collection"}]},{"title":"asdaddasd","iconUrl":"../images/collection-icon.png","contextMenu":[{"title":"Add Record"},{"title":"Drop Collection"}]}],"contextMenu":[{"title":"Add Collection"}]}],"contextMenu":[{"title":"Drop Database"}]},{"title":"te25","iconUrl":"../images/database-icon.jpg","childNodes":[{"title":"Collections","iconUrl":"../images/folder-icon.jpg","childNodes":[],"contextMenu":[{"title":"Add Collection"}]}],"contextMenu":[{"title":"Drop Database"}]},{"title":"test","iconUrl":"../images/database-icon.jpg","childNodes":[{"title":"Collections","iconUrl":"../images/folder-icon.jpg","childNodes":[{"title":"Collection 1","iconUrl":"../images/collection-icon.png","contextMenu":[{"title":"Add Record"},{"title":"Drop Collection"}]},{"title":"test6777","iconUrl":"../images/collection-icon.png","contextMenu":[{"title":"Add Record"},{"title":"Drop Collection"}]},{"title":"coll2","iconUrl":"../images/collection-icon.png","contextMenu":[{"title":"Add Record"},{"title":"Drop Collection"}]},{"title":"dadsadsads","iconUrl":"../images/collection-icon.png","contextMenu":[{"title":"Add Record"},{"title":"Drop Collection"}]},{"title":"colll3","iconUrl":"../images/collection-icon.png","contextMenu":[{"title":"Add Record"},{"title":"Drop Collection"}]},{"title":"colll5","iconUrl":"../images/collection-icon.png","contextMenu":[{"title":"Add Record"},{"title":"Drop Collection"}]},{"title":"collll23","iconUrl":"../images/collection-icon.png","contextMenu":[{"title":"Add Record"},{"title":"Drop Collection"}]},{"title":"asddd","iconUrl":"../images/collection-icon.png","contextMenu":[{"title":"Add Record"},{"title":"Drop Collection"}]},{"title":"adasadad","iconUrl":"../images/collection-icon.png","contextMenu":[{"title":"Add Record"},{"title":"Drop Collection"}]}],"contextMenu":[{"title":"Add Collection"}]}],"contextMenu":[{"title":"Drop Database"}]},{"title":"test2","iconUrl":"../images/database-icon.jpg","childNodes":[{"title":"Collections","iconUrl":"../images/folder-icon.jpg","childNodes":[{"title":"coll1","iconUrl":"../images/collection-icon.png","contextMenu":[{"title":"Add Record"},{"title":"Drop Collection"}]}],"contextMenu":[{"title":"Add Collection"}]}],"contextMenu":[{"title":"Drop Database"}]},{"title":"test22","iconUrl":"../images/database-icon.jpg","childNodes":[{"title":"Collections","iconUrl":"../images/folder-icon.jpg","childNodes":[{"title":"coll1","iconUrl":"../images/collection-icon.png","contextMenu":[{"title":"Add Record"},{"title":"Drop Collection"}]},{"title":"c","iconUrl":"../images/collection-icon.png","contextMenu":[{"title":"Add Record"},{"title":"Drop Collection"}]}],"contextMenu":[{"title":"Add Collection"}]}],"contextMenu":[{"title":"Drop Database"}]},{"title":"test23","iconUrl":"../images/database-icon.jpg","childNodes":[{"title":"Collections","iconUrl":"../images/folder-icon.jpg","childNodes":[],"contextMenu":[{"title":"Add Collection"}]}],"contextMenu":[{"title":"Drop Database"}]},{"title":"test24","iconUrl":"../images/database-icon.jpg","childNodes":[{"title":"Collections","iconUrl":"../images/folder-icon.jpg","childNodes":[],"contextMenu":[{"title":"Add Collection"}]}],"contextMenu":[{"title":"Drop Database"}]},{"title":"test26","iconUrl":"../images/database-icon.jpg","childNodes":[{"title":"Collections","iconUrl":"../images/folder-icon.jpg","childNodes":[],"contextMenu":[{"title":"Add Collection"}]}],"contextMenu":[{"title":"Drop Database"}]},{"title":"test27","iconUrl":"../images/database-icon.jpg","childNodes":[{"title":"Collections","iconUrl":"../images/folder-icon.jpg","childNodes":[],"contextMenu":[{"title":"Add Collection"}]}],"contextMenu":[{"title":"Drop Database"}]},{"title":"test28","iconUrl":"../images/database-icon.jpg","childNodes":[{"title":"Collections","iconUrl":"../images/folder-icon.jpg","childNodes":[],"contextMenu":[{"title":"Add Collection"}]}],"contextMenu":[{"title":"Drop Database"}]},{"title":"test29","iconUrl":"../images/database-icon.jpg","childNodes":[{"title":"Collections","iconUrl":"../images/folder-icon.jpg","childNodes":[],"contextMenu":[{"title":"Add Collection"}]}],"contextMenu":[{"title":"Drop Database"}]}],"contextMenu":[{"title":"Add Database"}]}];

(function(){
  var ID = function () {
    // Math.random should be unique because of its seeding algorithm.
    // Convert it to base 36 (numbers + letters), and grab the first 9 characters
    // after the decimal.
    return 'explorer-' + Math.random().toString(36).substr(2, 9);
  };
  //var template = document.getElementById("explorer-content-template").innerHTML;
  var template =   '<div class="explorer-header"><div class="explorer-icon"></div><div class="explorer-title-icon"></div><div class="explorer-title"></div></div>';

  this.Explorer = function(element, contents, options){
    var explorerEventsObject = {}, contextMenusObject = {};
    var titleProperty = options.titleProperty, iconProperty = options.iconProperty, childNodesProperty = options.childNodesProperty, clickProperty = options.clickProperty, contextMenuProperty = options.contextMenuProperty;

    function createTreeView(element, contents, options){
      if(contents){
        contents.forEach(function(item, index, array){
          var node = document.createElement('div');
          node.innerHTML = template;
          var explorerIcon = node.querySelector(".explorer-icon"),
          explorerTitle = node.querySelector(".explorer-title"),
          explorerTitleIcon = node.querySelector(".explorer-title-icon"),
          explorerHeader = node.querySelector(".explorer-header");

          explorerIcon.addEventListener("click", toggleChildNodes);
          explorerTitle.innerHTML = item[titleProperty];
          explorerTitle.id = ID();
          if(iconProperty && item[iconProperty]){
            explorerTitleIcon.style.backgroundImage = 'url("' + item[iconProperty] + '")';
          }
          else{
            explorerTitleIcon.classList.add('explorer-hide');
          }

          if(clickProperty && item[clickProperty]){
            explorerEventsObject[explorerTitle.id] = item[clickProperty];
          }

          if(contextMenuProperty && item[contextMenuProperty]){
            contextMenusObject[explorerTitle.id] = item[contextMenuProperty];
          }

          element.appendChild(node);
          if(childNodesProperty && item[childNodesProperty] && item[childNodesProperty].length){
            var childNode = document.createElement('div');
            childNode.className = "explorer-child-node explorer-child-node-margin explorer-hide";
            node.appendChild(childNode);
            createTreeView(childNode, item[childNodesProperty], options);
          }
          else{
            explorerIcon.classList.add('explorer-hidden');
          }

          //collapsing a node
          explorerIcon.classList.add('collapsed');
        });
      }
    }

    this.update = function (newContents) {
      updateTreeView(element, contents, newContents);
      contents = newContents;
    }

    function getNodeIndex(contentArray, id, startIndex){
      for (var index = startIndex; index < contentArray.length; index++) {
        if(contentArray[index].id === id){
          return index;
        }
      }
      return -1;
    }

    function updateTreeView(currentElement, oldContents, newContents){
      var result, startIndex = 0, nodeIndex, elementIndexOffset = 0;
      // for added and changed nodes
      newContents.forEach(function(item, index){
        nodeIndex = getNodeIndex(oldContents, item.id, startIndex);
        if(nodeIndex === -1){ // new node
          var newNode = document.createElement('div');
          createTreeView(newNode,[item], options);
          currentElement.insertBefore(newNode.children[0], currentElement.children[index]);
          elementIndexOffset++;
        }
        else{
          var node = currentElement.children[nodeIndex + elementIndexOffset];
          childNode = node.querySelector(".explorer-child-node");
          //set node position
          if( (nodeIndex + elementIndexOffset) !== index){
            currentElement.insertBefore(node, currentElement.children[index]);
          }
          if(nodeIndex === startIndex){
            startIndex++;
          }
          if(childNodesProperty && item[childNodesProperty] && item[childNodesProperty].length){
            if(!childNode){
              var explorerIcon = node.querySelector(".explorer-icon");
              explorerIcon.addEventListener("click", toggleChildNodes);
              explorerIcon.classList.remove("explorer-hidden");

              childNode = document.createElement('div');
              childNode.className = "explorer-child-node explorer-child-node-margin explorer-hide";
              node.appendChild(childNode);
            }
            updateTreeView( childNode,oldContents[nodeIndex][childNodesProperty], item[childNodesProperty]);
          }
          else if(childNode){
              deleteChildNode(childNode);
          }
        }
      });

      //for removed node
      for(index = newContents.length; index < currentElement.children.length; index++){
        if(!currentElement.children[index].classList.contains("explorer-contextmenu")){
          currentElement.removeChild(currentElement.children[index]);

          if(currentElement.children.length === 0){
              deleteChildNode(currentElement);
          }
        }
      }
    }

    function deleteChildNode(childNode){
      var parentNode = childNode.parentNode;
      parentNode.removeChild(childNode);

      var explorerIcon = parentNode.querySelector(".explorer-icon");
      explorerIcon.removeEventListener("click", toggleChildNodes);
      explorerIcon.classList.add("explorer-hidden");
      explorerIcon.classList.add("collapsed");
    }

    function toggleChildNodes(event){
      var icon = event.currentTarget;
      var node = icon.parentNode.parentNode;
      var childNode = node.querySelector(".explorer-child-node");
      if(childNode){
        icon.classList.toggle('collapsed');
        childNode.classList.toggle('explorer-hide');
      }
    }

    // click event
    document.addEventListener("click", function(event){
      var node = event.target,
      contextMenu = element.querySelector(".explorer-contextmenu");
      if(node.classList.contains("explorer-title")){
        var clickEvent = explorerEventsObject[node.id];
        if(clickEvent){
          clickEvent();
        }
      }

      else if(node.classList.contains("explorer-contextmenu-item")){
        var clickEvent = explorerEventsObject[node.id];
        if(clickEvent){
          clickEvent();
          if(contextMenu){
            contextMenu.classList.add("explorer-hide");
          }
        }
      }

      else{
        if(contextMenu){
          contextMenu.classList.add("explorer-hide");
        }
      }
    });

    //context menu
    document.addEventListener("contextmenu", function(event){
      var node = event.target;
      if(node.classList.contains("explorer-title")){
        event.preventDefault();
        var contextMenu = element.querySelector(".explorer-contextmenu");
        if (contextMenu) {
          contextMenu.style.top = event.clientY + "px";
          contextMenu.style.left = event.clientX + "px";
          contextMenu.innerHTML = ""; // Remove previous menu items
          menuItems = contextMenusObject[node.id];
          if(menuItems){
            contextNode.classList.remove("explorer-hide");
            menuItems.forEach(function(item){
              var menuItemNode = document.createElement('div');
              menuItemNode.innerHTML = item[titleProperty];
              menuItemNode.id = ID();
              menuItemNode.classList.add("explorer-contextmenu-item");

              if(clickProperty && item[clickProperty]){
                explorerEventsObject[menuItemNode.id] = item[clickProperty];
              }

              contextMenu.appendChild(menuItemNode);
            });
          }
        }
      }
    });

    //create tree view
    createTreeView(element, contents, options);

    //add contextmenu
    var contextNode = document.createElement('div');
    contextNode.classList.add("explorer-contextmenu");
    contextNode.classList.add("explorer-hide");
    element.appendChild(contextNode);
  }
})();
